name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday
    - cron: '0 0 * * 1'

env:
  CARGO_TERM_COLOR: always

jobs:
  coverage:
    name: Code Coverage Validation (85% per file)
    runs-on: ubuntu-latest
    needs: []  # Can run independently, but can also depend on test-linux if desired
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc
          cargo install cargo-tarpaulin
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run tests with coverage
        run: |
          cargo tarpaulin \
            --workspace \
            --all-features \
            --timeout 120 \
            --out Xml \
            --out Stdout \
            --exclude-files 'tests/*' \
            --exclude-files 'examples/*' \
            --exclude-files 'benches/*' \
            --exclude-files 'src/bin/*' \
            --exclude-files 'src/python/*' \
            --exclude-files 'target/*' \
            --exclude-files '**/main.rs' \
            --exclude-files '**/lib.rs' || true
      
      - name: Generate coverage report
        run: |
          if [ -f "scripts/check_coverage.sh" ]; then
            bash scripts/check_coverage.sh
          else
            echo "Coverage check script not found, using inline check"
            cargo tarpaulin \
              --workspace \
              --all-features \
              --timeout 120 \
              --out Stdout \
              --exclude-files 'tests/*' \
              --exclude-files 'examples/*' \
              --exclude-files 'benches/*' \
              --exclude-files 'src/bin/*' \
              --exclude-files 'src/python/*' \
              --exclude-files 'target/*' \
              --exclude-files '**/main.rs' \
              --exclude-files '**/lib.rs' | \
            grep -E "^\s+[0-9]+\.[0-9]+%" | \
            awk '{print $2, $1}' | \
            while read coverage file; do
              coverage_num=$(echo $coverage | sed 's/%//')
              if (( $(echo "$coverage_num < 85" | bc -l) )); then
                echo "❌ ERROR: $file has coverage $coverage (below 85% requirement)"
                exit 1
              else
                echo "✓ $file: $coverage"
              fi
            done
          fi
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./cobertura.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-umbrella
      
      - name: Coverage Summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All source files must have at least 85% coverage." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cargo tarpaulin \
            --workspace \
            --all-features \
            --timeout 120 \
            --out Stdout \
            --exclude-files 'tests/*' \
            --exclude-files 'examples/*' \
            --exclude-files 'benches/*' \
            --exclude-files 'src/bin/*' \
            --exclude-files 'src/python/*' \
            --exclude-files 'target/*' \
            --exclude-files '**/main.rs' \
            --exclude-files '**/lib.rs' | \
          grep -E "^\s+[0-9]+\.[0-9]+%" | \
          awk '{printf "| %s | %s |\n", $2, $1}' >> $GITHUB_STEP_SUMMARY || true

